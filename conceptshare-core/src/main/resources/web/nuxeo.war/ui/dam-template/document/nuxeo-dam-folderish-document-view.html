<link rel="import" href="../justified-grid/nuxeo-dam-data-justified.html">
<!--
`custom-folderish-view`
@group Nuxeo UI
@element custom-folderish-view
-->
<dom-module id="nuxeo-dam-folderish-document-view">
  <template>
    <style>

      .results {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        min-height: calc(100vh - 14em);
        margin-top: 8px;
        border: 2px solid transparent;
      }

      .results.dragging {
        border: 2px dashed var(--nuxeo-primary-color);
      }

      nuxeo-data-grid {
        display: block;
        position: relative;
      }

      nuxeo-tag {
        margin-right: 2px;
      }

      .ellipsis {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        display: block;
        width: calc(100% - 38px);
      }

      .capitalize {
        text-transform: capitalize;
      }

      nuxeo-results {
        --layout-vertical: {
          position: relative;
        };
        --layout-horizontal: {
          position: absolute;
          right: 8px;
          top: 8px;
          z-index: 5;
        };
      }

      .content {
        padding: 0px;
      }

      nuxeo-dam-data-justified {
        margin-top: -48px !important;
        background: var(--nuxeo-page-background) !important;
      }

    </style>

    <nuxeo-page-provider id="myProvider" auto
                         provider="[[provider]]"
                         page-size="[[pageSize]]"
                         enrichers="thumbnail"
                         page="[[pageNumber]]"
                         params="[[params]]"
                         schemas="dublincore,common,uid,file,picture,thumbnail"
                         headers='{"X-NXfetch.document": "properties", "X-NXtranslate.directoryEntry": "label"}'>
    </nuxeo-page-provider>

    <div id="dropzone">
      <nuxeo-results name="[[document.uid]]" nx-provider="[[nxProvider]]" selected-items="{{selectedItems}}" display-mode="justified">
        <div class="selectionActions">
          <nuxeo-slot slot="BROWSE_ACTIONS" model="[[browseActionContext]]"></nuxeo-slot>
        </div>

        <!-- justified grid view -->
        <nuxeo-dam-data-justified class="results"
                                  name="justified"
                                  icon="icons:view-array"
                                  empty-label="[[emptyLabel]]"
                                  empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                                  selection-enabled display-quick-filters>
        </nuxeo-dam-data-justified>

        <!-- Grid view -->
        <nuxeo-data-grid class="results" name="grid" icon="icons:apps"
                         empty-label="[[emptyLabel]]"
                         empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                         selection-enabled display-quick-filters>
          <template>
            <nuxeo-document-grid-thumbnail tabindex$="{{tabIndex}}"
                                           selected$="{{selected}}"
                                           doc="[[item]]" on-navigate="_navigate">
            </nuxeo-document-grid-thumbnail>
          </template>
        </nuxeo-data-grid>

        <!-- Table view -->
        <nuxeo-data-table class="results" name="table" icon="icons:list"
                          settings-enabled
                          empty-label="[[emptyLabel]]"
                          empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                          selection-enabled
                          display-quick-filters
                          on-row-clicked="_navigate">
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.title')]]"
                                   field="dc:title" sort-by="dc:title" flex="100">
            <template>
              <nuxeo-document-thumbnail document="[[item]]"></nuxeo-document-thumbnail>
              <a class="title ellipsis" href$="[[urlFor('browse', item.path)]]" on-click="_navigate">[[item.title]]</a>
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.modified')]]"
                                   field="dc:modified" sort-by="dc:modified"
                                   filter-by="dc_modified_agg"
                                   flex="50">
            <template is="header">
              <nuxeo-dropdown-aggregation
                placeholder="[[i18n('documentContentView.datatable.header.modified')]]"
                data="[[aggregations.dc_modified_agg]]"
                value="{{column.filterValue}}" multiple>
              </nuxeo-dropdown-aggregation>
            </template>
            <template>
              [[formatDate(item.properties.dc:modified)]]
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                                   filter-by="dc_last_contributor_agg" field="dc:lastContributor" sort-by="dc:lastContributor" flex="50">
            <template is="header">
              <nuxeo-dropdown-aggregation
                placeholder="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                data="[[aggregations.dc_last_contributor_agg]]"
                value="{{column.filterValue}}" multiple>
              </nuxeo-dropdown-aggregation>
            </template>
            <template>
              <nuxeo-user-tag user="[[item.properties.dc:lastContributor]]"></nuxeo-user-tag>
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.state')]]"
                                   field="currentLifeCycleState" hidden>
            <template><span class="capitalize">[[item.state]]</span></template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.version')]]"
                                   field="versionLabel" hidden>
            <template>
              [[formatVersion(item)]]
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.created')]]"
                                   field="dc:created" flex="50" hidden>
            <template>
              [[formatDate(item.properties.dc:created)]]
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.author')]]"
                                   field="dc:creator" hidden>
            <template>
              <nuxeo-user-tag user="[[item.properties.dc:creator]]"></nuxeo-user-tag>
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.nature')]]"
                                   field="dc:nature" hidden>
            <template>
              <nuxeo-tag hidden$="[[!item.properties.dc:nature]]">
                [[formatDirectory(item.properties.dc:nature)]]
              </nuxeo-tag>
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.coverage')]]"
                                   field="dc:coverage" hidden>
            <template>
              <nuxeo-tag hidden$="[[!item.properties.dc:coverage]]">
                [[formatDirectory(item.properties.dc:coverage)]]
              </nuxeo-tag>
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.subjects')]]"
                                   field="dc:subjects" hidden flex="60">
            <template>
              <template is="dom-repeat" items="[[item.properties.dc:subjects]]" as="subject">
                <nuxeo-tag>[[formatDirectory(subject)]]</nuxeo-tag>
              </template>
            </template>
          </nuxeo-data-table-column>
        </nuxeo-data-table>

      </nuxeo-results>
    </div>
    <paper-toast id="toast" duration="0"></paper-toast>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        behaviors: [Nuxeo.LayoutBehavior],
        is: 'nuxeo-dam-folderish-document-view',
        properties: {
          /**
           * @doctype Workspace
           */
          document: {
            type: Object
          },
          params: {
            type: Object,
            value: {},
            notify: true
          },
          provider: {
            type: String,
            value: 'folderish-content'
          },
          pageSize: {
            type: Number,
            value: 20
          },
          currentIndex: {
            type: Number,
            notify: true
          },
          browseActionContext: {
            type: Object,
            computed: '_browseActionContext(document, selectedItems)'
          }
        },

        listeners: {
          'document-created': '_handleDocumentCreated',
          'dropzone.dragover': '_dragoverImport',
          'dropzone.dragleave': '_dragleaveImport',
          'dropzone.drop': '_dropImport'
        },

        observers: [
          '_refresh(params)',
          '_observeDocument(document)'
        ],

        ready: function() {
          this.nxProvider = this.$.myProvider;
        },

        _observeDocument: function() {
          if (this.document) {
            this.params = {'queryParams': this.document.uid};
          }
        },

        _refreshAndFetch: function() {
          var pn = this.nxProvider.page;
          this._refresh();
          if (pn === 1) {
            // normally the page provider is on auto mode
            // so the fetch should be triggered when changing page
            this.nxProvider.fetch();
          }
        },

        _refresh: function() {
          this.$.myProvider.page = 1;
        },

        _navigate: function(e) {
          this.fire('navigate', {doc: (e.model || e.detail).item});
        },

        _computedClass: function(isSelected) {
          var classes = 'grid-box';
          if (isSelected) {
            classes += ' selected';
          }
          return classes;
        },

        _dragoverImport: function(e) {
          e.preventDefault();
          this.$.toast.text = this.i18n('documentContentView.drag.import');
          this.$.toast.open();
          this._toggleDragging(true);
        },

        _dragleaveImport: function() {
          this.$.toast.close();
          this._toggleDragging(false);
          this.toggleClass('dragging', false, this.$.grid);
          this.toggleClass('dragging', false, this.$.table);
        },

        _dropImport: function(e) {
          e.preventDefault();
          this.$.toast.close();
          this._toggleDragging(false);
          this.fire('create-document', {files: e.dataTransfer.files});
        },

        _toggleDragging: function(flag) {
          Polymer.dom(this.root).querySelectorAll('.results').forEach(function(e) {
            this.toggleClass('dragging', flag, e);
          }.bind(this));
        },

        _handleDocumentCreated: function() {
          this.fire('document-updated');
        },

        _browseActionContext: function() {
          return {document: this.document, selectedItems: this.selectedItems};
        }

      });
    })();
  </script>
</dom-module>
