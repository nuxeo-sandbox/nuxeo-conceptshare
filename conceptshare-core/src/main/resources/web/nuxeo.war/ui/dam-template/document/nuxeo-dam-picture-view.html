<link rel="import" href="../document-widgets/nuxeo-dam-document-workflows.html">
<link rel="import" href="../document-widgets/nuxeo-dam-document-info.html">
<link rel="import" href="../document-widgets/nuxeo-dam-document-collections.html">
<link rel="import" href="../document-widgets/nuxeo-dam-document-exif-metadata.html">
<link rel="import" href="../document-widgets/nuxeo-dam-document-iptc-metadata.html">
<link rel="import" href="../document-widgets/nuxeo-dam-document-info-bar.html">
<link rel="import" href="../actions/nuxeo-dam-creative-review-start.html">
<!--
`custom-document-view`
@group Nuxeo UI
@element custom-document-view
-->
<dom-module id="nuxeo-dam-picture-view">
  <template>
    <style>

      .viewer {
        background-color: #333;
        width: calc(100% + 32px);
        height: 100%;
        margin: var(--custom-viewer-margin,-72px -16px 0px -16px);
        position: relative;
        z-index:1;
        padding-top:1%;
        padding: 0px;
        @apply(--custom-viewer);
      }

      .actions {
        height: 40px;
        width: calc(100% + 32px);
        margin-left: -16px;
        text-align: center;
      }

      .icons {
        --iron-icon-width: 24px;
        --iron-icon-height: 24px;
      }

      .container {
        margin-left: var(--custom-view-side-padding,10%);
        margin-right: var(--custom-view-side-padding,10%);
        justify-content: space-around;
      }

      .item {
        min-width: 350px;
        margin:16px;
      }

      .metadata {
        flex: 1 100%;
        margin: 16px;
      }

      .relative {
        position: relative;
      }

      paper-card {
        border-style: none;
        padding: 8px;
        height: 100%;
      }

      nuxeo-document-info-bar ::content .bar {
        margin-bottom: 0px;
      }

      .title-text {
        padding: 16px;
        font-size: 24px;
        font-weight: 400;
        display: inline-block;
      }

      #edit {
        display: inline-block;
      }

      img {
        margin: 0 auto;
        display: block;
        min-height: 50vh;
        max-height: 70vh;
        max-width:100%;
        object-fit:contain;
      }

    </style>

    <div class="viewer">
      <nuxeo-dam-document-info-bar document="[[document]]"></nuxeo-dam-document-info-bar>
      <!--nuxeo-document-preview document="[[document]]" controls responsive></nuxeo-document-preview-->
      <img src="[[_computeImageSource(document)]]"/>
    </div>

    <template is="dom-if" if="[[displayActions]]">
      <div class="actions">
        <nuxeo-add-to-collection-button document="[[document]]" class="icons"></nuxeo-add-to-collection-button>
        <nuxeo-favorites-toggle-button document="[[document]]" class="icons"></nuxeo-favorites-toggle-button>
        <nuxeo-share-button document="[[document]]" class="icons"></nuxeo-share-button>
        <nuxeo-notifications-toggle-button document="[[document]]" class="icons"></nuxeo-notifications-toggle-button>
        <nuxeo-lock-toggle-button document="[[document]]" class="icons"></nuxeo-lock-toggle-button>
        <nuxeo-preview-button  document="[[document]]" class="icons"></nuxeo-preview-button>
        <nuxeo-download-button document="[[document]]" class="icons"></nuxeo-download-button>
        <nuxeo-drive-edit-button document="[[document]]" blob="[[document.properties.file:content]]" class="icons"></nuxeo-drive-edit-button>
        <nuxeo-dam-creative-review-start document="[[document]]"></nuxeo-dam-creative-review-start>
        <template is="dom-if" if="[[hasFacet(document, 'Versionable')]]">
          <nuxeo-document-versions document="[[document]]"></nuxeo-document-versions>
        </template>
        <nuxeo-tag uppercase>[[document.state]]</nuxeo-tag>
      </div>
    </template>

    <div class="layout horizontal wrap container">
      <div class="item flex">
        <paper-card elevation="0" hidden$="[[edit]]">
          <div class="layout horizontal" style="align-items: center;">
            <div class="title-text">
              Metadata
            </div>
            <paper-icon-button id="edit" icon="editor:mode-edit" on-tap="_editMode" hidden$="[[!_canEdit(document)]]"></paper-icon-button>
          </div>
          <div class="card-content">
            <nuxeo-document-metadata document="[[document]]"></nuxeo-document-metadata>
          </div>
        </paper-card>
        <paper-card hidden$="[[!edit]]" heading="Metadata" elevation="0">
          <div class="card-content">
            <nuxeo-document-edit document="[[document]]"></nuxeo-document-edit>
          </div>
        </paper-card>
      </div>
      <div class="item flex">
        <paper-card heading="Image Properties" elevation="0">
          <div class="card-content">
            <nuxeo-picture-info document="[[document]]"></nuxeo-picture-info>
          </div>
        </paper-card>
      </div>
      <div class="item flex">
        <paper-card heading="Tags" elevation="0">
          <div class="card-content">
            <nuxeo-tag-suggestion
                                  document="[[document]]"
                                  allow-new-tags
                                  placeholder="[[i18n('documentPage.tags.placeholder')]]"
                                  readonly="[[_canEdit(document)]]">
            </nuxeo-tag-suggestion>
          </div>
        </paper-card>
      </div>
      <div class="item flex">
        <paper-card heading="Collections" elevation="0">
          <div class="card-content">
            <nuxeo-dam-document-collections document="[[document]]"></nuxeo-dam-document-collections>
          </div>
        </paper-card>
      </div>

      <div class="metadata flex">
        <paper-card elevation="0" heading="Renditions">
          <div class="card-content">
            <nuxeo-picture-formats role="widget" document="[[document]]"></nuxeo-picture-formats>
          </div>
        </paper-card>
      </div>

      <div class="item flex">
        <paper-card heading="System Information" elevation="0">
          <div class="card-content">
            <nuxeo-dam-document-info document="[[document]]"></nuxeo-dam-document-info>
          </div>
        </paper-card>
      </div>
      <template is="dom-if" if="[[displayWorkflow]]">
        <div class="item flex">
          <paper-card elevation="0" heading="Workflows">
            <div class="card-content">
              <nuxeo-dam-document-workflows document="[[document]]"></nuxeo-dam-document-workflows>
            </div>
          </paper-card>
        </div>
      </template>
      <div class="metadata flex">
        <paper-card elevation="0" heading="Embedded EXIF">
          <div class="card-content">
            <nuxeo-dam-document-exif-metadata document="[[document]]"></nuxeo-dam-document-exif-metadata>
          </div>
        </paper-card>
      </div>
      <div class="metadata flex">
        <paper-card elevation="0" heading="Embedded IPTC">
          <div class="card-content">
            <nuxeo-dam-document-iptc-metadata document="[[document]]"></nuxeo-dam-document-iptc-metadata>
          </div>
        </paper-card>
      </div>
    </div>

  </template>

  <script>
  (function() {
    'use strict';
    Polymer({
      is: 'nuxeo-dam-picture-view',
      behaviors: [Nuxeo.LayoutBehavior],
      properties: {
        document: {
          type: Object,
          observer: '_documentChanged'
        },
        edit: {
          type: Boolean,
          value: false
        },
        displayActions: {
          type: Boolean,
          value: false
        },
        isDisplayedInTask: {
          type: Boolean,
          value: false
        }
      },

      observers:['_computeDisplayWorkflow(document,isDisplayedInTask)'],

      _documentChanged: function() {
        if (this.document) {
          this.edit = false;
        }
      },

      _isMutable: function(doc) {
        return !this.hasFacet(doc, 'Immutable') && doc.type !== 'Root' && doc.state !== 'deleted';
      },

      _canEdit: function(doc) {
        return doc && doc.type !== 'Root' && this.hasPermission(doc, 'Write') && this._isMutable(doc);
      },

      _editMode: function() {
        this.edit = true;
      },

      _computeImageSource: function(doc) {
        if (this.document && this.document.properties && this.document.properties['picture:views']) {
          var filteredViews = this.document.properties['picture:views'].filter(function(view) {
            return view.title === 'FullHD';
          });
          if (filteredViews.length > 0) {
            return filteredViews[0].content.data;
          }
        }
        if (this.xpath) {
          this._updateBlob();
          if (this._blob && this._blob['mime-type'].match('image.*')) {
            return this._blob.data;
          }
        }
      },

      _computeDisplayWorkflow: function() {
        this.displayWorkflow = !this.isDisplayedInTask && this.document && !this.document.isProxy;
      }

    });
  })();
  </script>
</dom-module>
