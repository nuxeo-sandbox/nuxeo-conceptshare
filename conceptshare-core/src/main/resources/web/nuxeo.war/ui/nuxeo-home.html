<link rel="import" href="dam-template/horizontal-scroll/nuxeo-dam-horizontal-scroll.html">
<link rel="import" href="dam-template/horizontal-scroll/nuxeo-dam-horizontal-scroll-item.html">
<link rel="import" href="dam-template/thumbnail/nuxeo-dam-thumbnail.html">
<link rel="import" href="dam-template/tasks/nuxeo-dam-task-thumbnail.html">
<link rel="import" href="dam-template/actions/nuxeo-dam-share-icon.html">
<link rel="import" href="dam-template/actions/nuxeo-dam-share-dialog.html">
<link rel="import" href="dam-template/actions/nuxeo-dam-preview-icon.html">
<link rel="import" href="dam-template/actions/nuxeo-dam-preview-dialog.html">
<!--
`nuxeo-home`
@group Nuxeo UI
@element nuxeo-home
-->
<dom-module id="nuxeo-home">
  <template>
    <style>

      :host {
        height: 100%;
      }

      h2 {
        margin-top: 7vh;
        font-weight: bold;
        color: var(--nuxeo-header-title-color);
      }

      .header {
        color: var(--nuxeo-header-title-color) !important;
      }

      .row {
        height:200px;
        width:100%;
      }

      .task {
        min-height:100%;
        max-height:100%;
        width: 300px;
      }

      nuxeo-dam-horizontal-scroll-item {
        display: inline-block;
      }

    </style>

    <nuxeo-connection id="nxcon"></nuxeo-connection>

    <nuxeo-page>
      <div class="header">Home</div>
      <div class="content main">
        <section name="dashboard">

          <!-- tasks -->
          <nuxeo-resource auto
                          id="tasks"
                          path="/task"
                          headers='{"X-NXfetch.task": "targetDocumentIds,actors"}'
                          enrichers="thumbnail"
                          response="{{myTasks}}">
          </nuxeo-resource>
          <template is="dom-if" if="[[_hasTasks(myTasks)]]">
            <h2>My Tasks</h2>
            <div class="row">
              <nuxeo-dam-horizontal-scroll>
                <template is="dom-repeat" items="[[myTasks.entries]]">
                  <nuxeo-dam-horizontal-scroll-item class="task">
                    <nuxeo-dam-task-thumbnail task="[[item]]"></nuxeo-dam-task-thumbnail>
                  </nuxeo-dam-horizontal-scroll-item>
                </template>
              </nuxeo-dam-horizontal-scroll>
            </div>
          </template>

          <!-- recently edited -->
          <h2>Recent Activity</h2>
          <nuxeo-page-provider auto
                               id="latestQuery"
                               page-size="8"
                               provider="recently-modified"
                               schemas="dublincore,common,uid,file,picture"
                               headers='{"X-NXfetch.document": "properties"}'
                               enrichers="thumbnail"
                               on-update="latest_update">
          </nuxeo-page-provider>

          <div class="row">
            <nuxeo-dam-horizontal-scroll>
              <template is="dom-repeat" items="[[latest]]">
                <nuxeo-dam-horizontal-scroll-item>
                  <nuxeo-dam-thumbnail document="[[item]]" actions-enabled="true">
                    <nuxeo-download-button document="[[item]]"></nuxeo-download-button>
                    <nuxeo-dam-share-icon document="[[item]]" class="icons" on-tap="_display_direct_link"></nuxeo-dam-share-icon>
                    <nuxeo-dam-preview-icon  document="[[item]]" class="icons" on-tap="_display_preview"></nuxeo-dam-preview-icon>
                  </nuxeo-dam-thumbnail>
                </nuxeo-dam-horizontal-scroll-item>
              </template>
            </nuxeo-dam-horizontal-scroll>
          </div>

          <!-- Favorites -->
          <nuxeo-operation id="fetchFavOp" op="Favorite.Fetch" response="favorite"></nuxeo-operation>
          <nuxeo-page-provider id="favoritesProvider"
                               provider="default_content_collection"
                               page-size="20"
                               schemas="dublincore,common,uid,file,picture,video"
                               headers='{"X-NXfetch.document": "properties"}'
                               enrichers="thumbnail"
                               on-update="favorites_update">
          </nuxeo-page-provider>

          <template is="dom-if" if="[[_hasFavorites(favorites)]]">
            <h2>Latest Favorites</h2>
            <div class="row">
              <nuxeo-dam-horizontal-scroll id="favoritesScroll">
                <template is="dom-repeat" items="[[favorites]]">
                  <nuxeo-dam-horizontal-scroll-item>
                    <nuxeo-dam-thumbnail document="[[item]]" actions-enabled="true">
                      <nuxeo-download-button document="[[item]]"></nuxeo-download-button>
                      <nuxeo-dam-share-icon document="[[item]]" class="icons" on-tap="_display_direct_link"></nuxeo-dam-share-icon>
                      <nuxeo-dam-preview-icon  document="[[item]]" class="icons" on-tap="_display_preview"></nuxeo-dam-preview-icon>
                    </nuxeo-dam-thumbnail>
                  </nuxeo-dam-horizontal-scroll-item>
                </template>
              </nuxeo-dam-horizontal-scroll>
            </div>
          </template>
        </section>
        <nuxeo-dam-share-dialog id="shareDialog"></nuxeo-dam-share-dialog>
        <nuxeo-dam-preview-dialog id="previewDialog"></nuxeo-dam-preview-dialog>
      </div>
    </nuxeo-page>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'nuxeo-home',
      behaviors: [Nuxeo.RoutingBehavior, Nuxeo.FormatBehavior],
      properties: {

      },

      _navigate: function(e) {
        var detail;
        if (e.detail.item) {
          detail = {
            doc: e.detail.item
          };
          page('/browse' + detail.doc.path);
        } else {
          detail = {
            doc: e.model.item
          };
        }
        this.fire('navigate', detail);
      },

      ready: function() {
        this._fetchFavorite().then(function(favorite) {
          this.$.favoritesProvider.params = [favorite.uid];
          this.$.favoritesProvider.page = 1;
          this.$.favoritesProvider.fetch();
        }.bind(this));
      },

      _fetchFavorite: function() {
        if (this.favorite) {
          return Promise.resolve(this.favorite);
        } else {
          return this.$.fetchFavOp.execute()
            .then(function(resp) {
            this.favorite = resp;
            return resp;
          }.bind(this));
        }
      },

      latest_update: function(e) {
        this.set('latest',this.$.latestQuery.currentPage);
      },

      favorites_update: function(e) {
        this.set('favorites',this.$.favoritesProvider.currentPage);
      },

      _updateProjects: function(e) {
        this.set('projects',this.$.projectsProvider.currentPage);
      },

      _hasFavorites: function(favorites) {
        return this.favorites && this.favorites.length>0;
      },

      _hasProjects: function(projects) {
        return this.projects && this.projects.length>0;
      },

      _hasTasks: function(myTasks) {
        return myTasks && myTasks.entries.length>0;
      },

      _display_direct_link:function(e) {
        var doc = e.model.item;
        var dialog = this.$.shareDialog;
        dialog.document = doc;
        dialog.toggleDialog();
      },

      _display_preview:function(e) {
        var doc = e.model.item;
        var dialog = this.$.previewDialog;
        dialog.document = doc;
        dialog.toggleDialog();
      }

    });
  })();
  </script>

</dom-module>
